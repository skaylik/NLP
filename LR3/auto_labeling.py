# auto_labeling.py
""" Этап 1
Модуль для автоматической разметки данных
Использует правила на основе ключевых слов
"""

import json
import re
from typing import Dict, List, Tuple
from collections import Counter
import random

# ========== НАСТРОЙКИ ==========

# Маппинг для женского/лайфстайл сайта (ключи в нижнем регистре)
CATEGORY_MAPPING = {
    "новости": "celebrities",  # По умолчанию Звезды, но может быть Развлечения
    "мой дом": "relationships",  # По умолчанию Отношения, но может быть Кулинария
    "стиль": "fashion",  # Стиль
    "звезды": "celebrities",  # Звезды
    "досуг": "entertainment",  # Развлечения
    "кино": "cinema",  # Кино
    "гороскопы": "esoterics",  # Эзотерика
    "здоровье": "health",  # Здоровье
    "быт": "home",  # Быт
    "дом": "home",  # Быт
    "домашний очаг": "home",  # Быт
    "кулинария": "cooking",  # Кулинария
    "музыка": "music",  # Музыка
    "красота": "health",  # Дополнительная категория для косметологии
    "путешествия": "entertainment"  # Дополнительная категория
}

# Маппинг тем на русские названия для вывода
TOPIC_RUSSIAN_NAMES = {
    "cinema": "Кино",
    "music": "Музыка",
    "cooking": "Кулинария",
    "esoterics": "Эзотерика",
    "health": "Здоровье",
    "fashion": "Мода",
    "relationships": "Отношения",
    "celebrities": "Звезды",
    "entertainment": "Развлечения",
    "home": "Быт"
}

def translate_topics_to_russian(topics: List[str]) -> List[str]:
    """
    Перевод тем с английского на русский для вывода
    
    Args:
        topics: список тем на английском
        
    Returns:
        список тем на русском
    """
    return [TOPIC_RUSSIAN_NAMES.get(topic, topic) for topic in topics]

# ========== ТОНАЛЬНОСТЬ - ИСПРАВЛЕННЫЕ ПРАВИЛА ==========

# ЯВНЫЕ маркеры негатива (скандалы, конфликты, критика)
STRONG_NEGATIVE = [
    # Смерть и гибель
    'смерть', 'умер', 'умерла', 'умерли', 'умирает', 'умирают', 
    'погиб', 'погибла', 'погибли', 'гибель', 'похорон', 'похоронили',
    'скончал', 'скончалась', 'скончались', 'кончина', 'умерших',
    
    # Горе и утрата
    'горе', 'горем', 'горя', 'утрат', 'утрата', 'утратой', 'утраты',
    'потер', 'потеря', 'потери', 'потерь', 'потерях',
    'боль', 'боли', 'болью', 'болей', 'болезн', 'скорб', 'скорби',
    'скорбью', 'печал', 'печаль', 'печали', 'печалью', 'груст', 'грусть',
    'грусти', 'тоск', 'тоска', 'тоски', 'тоской', 'слез', 'слезы', 'слезами',
    'плач', 'плакать', 'плачу', 'похорон', 'похороны',
    
    # Конфликты и скандалы
    'скандал', 'скандальн', 'скандалн', 'конфликт', 'ссор', 'ссора', 
    'вражд', 'враждебн', 'раздор', 'позор', 'позорн',
    'компрометирующ', 'компрометац', 'обвинен', 'обвинена', 'обвинены',
    'обвиняют', 'обвинени', 'суд', 'судиться', 'судебн', 'иск', 'подал иск',
    
    # Негативные оценки и критика
    'обидно', 'обидн', 'несправедливо', 'несправедлив', 'лишили', 'лишил',
    'лишила', 'нелепый', 'нелепо', 'нелепая', 'нелепое', 'неудачн',
    'неприятно', 'неприятн', 'неприятный', 'неприятная', 'неприятное',
    'поразила', 'поразил', 'поразило', 'выходка', 'выходк',
    'швырнула', 'швырнул', 'потрясла', 'потряс', 'потрясло',
    'дикий', 'дикая', 'дикое', 'странный', 'странно', 'странная',
    'не по возрасту', 'не по возрасту наряд',
    'что с ней такое', 'неприятно поразила', 'негатив', 'негативн',
    
    # Унижение и стыд
    'унизительн', 'унижен', 'унизила', 'унизил', 'стыд', 'стыдн',
    'смущен', 'смущена', 'смущенно', 'жалость', 'жалко', 'жалост',
    'сочувств', 'сочувствие', 'унизительных выходов', 'унизительный выход',
    
    # Проблемы и трудности
    'проблем', 'трудност', 'кризис', 'потеря', 'уход', 'увольнение',
    'недоволь', 'жалоб', 'критик', 'критикует', 'критикуют',
    'разочарован', 'разочарована', 'разочарованы',
    'не рекомендую', 'не советую', 'плох', 'плохо',
    
    # Измена и предательство
    'измен', 'измена', 'изменил', 'изменила', 'предательств', 'предал',
    
    # Негативные события
    'ядерная война', 'ядерный апокалипсис', 'порог войны',
    'военные базы', 'разведка', 'удар', 'ответный удар',
    'геополитическ', 'соперничество', 'холодная война',
    
    # Звездные скандалы
    'скандал с разоблачениями', 'разоблачен', 'разоблачил',
    'разоблачила', 'королевск скандал', 'королевск конфликт',
    'судиться со своим дворецким', 'дворецкий', 'обидчик',
    'потерпевшая сторона', 'новый скандал', 'бедный', 'бедная',
    'злорадств', 'злорадство', 'напаст', 'напасть', 'насмешк', 'насмешка',
    'насмешки', 'повредить', 'ударит', 'отрекается', 'бед', 'беды',
    'конфликт', 'неурядиц', 'рукоприкладства', 'опасное', 'кувырком',
    'негативн'
]

# Явные маркеры позитива
STRONG_POSITIVE = [
    'прекрасн', 'великолепн', 'восхитительн', 'замечательн', 'потрясающ',
    'чудесн', 'изумительн', 'блестящ', 'совершенн', 'идеальн',
    'радост', 'счастлив', 'любов', 'успех', 'победа', 'праздник',
    'порадовал', 'порадовала', 'порадовали', 'радует', 'радуют',
    'поделился', 'поделилась', 'поделились', 'счастливый момент',
    'любим', 'обожает', 'обожают', 'гордится', 'гордятся', 'горд',
    'мечта', 'надежда', 'красив', 'восторг', 'удача', 'достижение',
    'награда', 'приз', 'подарок', 'сюрприз', 'поздравлени',
    'рад', 'смех', 'улыбк', 'обнима', 'целова', 'доволен',
    'восхищен', 'любит', 'любят', 'любить',
    'интересно', 'увлекательно', 'захватывающ', 'незабываем',
    'фестиваль', 'приглашает', 'приглашаем', 'приглашение',
    'гостей ждут', 'гостей ждёт', 'ждём', 'ждем', 'приходите',
    'посетите', 'заходите', 'рады видеть', 'будем рады',
    'с нетерпением ждем', 'не пропустите', 'уникальн', 'эксклюзивн',
    'ярмарк', 'ярмарка', 'афиша', 'анонс', 'анонсировал',
    'модн', 'тренд', 'стильн', 'элегантн', 'шикарн', 'роскошн',
    'гламурн', 'красив', 'привлекательн', 'обворожительн',
    'очаровательн', 'неотразим', 'обаятельн', 'доброжелательн',
    'образцов', 'образцовая', 'талант', 'талантлив', 'уникальн',
    'невероятн', 'историческ значим', 'масштабн', 'помощь', 'совет',
    'рекомендац', 'советуем', 'рекомендуем', 'полезн', 'эффективн',
    'легк', 'просто', 'быстр', 'весел', 'весело', 'интересн',
    'познавательн', 'образовательн', 'развива', 'развитие',
    'совершенствован', 'улучшен', 'улучшен', 'обновлен',
    'новинк', 'новшеств', 'инновац', 'модерн', 'современн',
    'ценный', 'ценный опыт', 'радость', 'добр', 'добрый', 'тепл',
    'поддержк', 'доверие', 'свобод', 'свобода', 'любимый', 'любимая',
    'воспоминания', 'воспоминание', 'память', 'памяти', 'сердце',
    'любви', 'любовью', 'сокровище', 'положительн', 'нейтральн',
    'нейтральное', 'положительное', 'хорош', 'хорошо',
    
    # Дополнительные позитивные слова для туризма
    'турецкие каникулы', 'эгейском побережье', 'путешестви', 'отдых', 'отдыха',
    'каникул', 'курорт', 'отпуск', 'тур', 'поездк', 'впечатлений', 'вдохновляя',
    
    # Праздники и поздравления
    'день отца', 'открыток', 'картинок', 'слов любви', 'благодарности',
    'поздравления', 'поздравить', 'теплых слов', 'добрых открыток',
    'обнять папу', 'спасибо', 'поздравляем', 'с праздником', 'праздник',
    
    # События и культура
    'фестивал', 'театральных искусств', 'открытие', 'торжественное',
    'красную дорожку', 'артистов', 'театральных деятелей', 'мероприят',
    'события', 'гид по', 'ноябрь без скуки', 'заряженные события',
    'интересностей', 'научный квест', 'приключением', 'драйвом', 'пользой',
    
    # Образование и развитие
    'программа', 'мама-предприниматель', 'обучение', 'поддержк',
    'проект', 'участницы', 'женское предпринимательство', 'развитие',
    'реализуется', 'минэкономразвития', 'федеральная программа',
    
    # Косметология
    'ботокс', 'омоложения', 'уколы красоты', 'красивый результат',
    'естественный результат', 'грамотный подход', 'ботулинотерапия',
    'популярная процедура', 'эстетической медицине', 'развенчивает мифы',
    
    # Детские темы
    'детей', 'подростков', 'детск', 'ребенок', 'гид по',
    'мероприятия для детей', 'квест', 'интерактивн', 'научный',
    
    # Общие улучшения
    'топ-10', 'топ 10', 'рекомендац', 'совет', 'лучшие', 'новинк',
    'подарк', 'сюрприз', 'успех', 'победа', 'достижение', 'улучшение',
    'помощь', 'вдохновен', 'познавательн', 'образовательн', 'полезн',
    'эффективн', 'легк', 'просто', 'быстр', 'весел', 'интересн',
    'новинк', 'современн', 'ценный', 'радость', 'добр', 'тепл',
    'доверие', 'свобода', 'любимый', 'память', 'сердце', 'любви',
    
    # Новые позитивные слова для звездных новостей
    'переезд', 'новое место жительства', 'осваивают искусство', 'впечатляющих успехов',
    'блеском', 'тайный', 'конспирация', 'папарацци', 'представитель', 'официальный',
    'живут', 'санта барбара', 'беверли хиллз', 'лос-анджелес', 'калифорнийских'
]

# Слова, которые НЕ являются негативными в контексте описания
NEUTRAL_IN_CONTEXT = [
    'ядерная война', 'холодная война', 'геополитическ', 'соперничество',
    'разведка', 'военные базы', 'историческ', 'шпионск', 'боевик',
    'фильм', 'сериал', 'кино', 'сюжет', 'персонаж', 'герой',
    'роль', 'актер', 'режиссер', 'сценарий', 'премьер',
    'измен', 'смерть', 'любов', 'страсть', 'ревност', 'завист',
    'предательств', 'драма', 'трагеди', 'мелодрама', 'триллер',
    'хоррор', 'ужас', 'страшн', 'устрашающ', 'мистическ',
    'к чему снится', 'сон', 'снится', 'толкование', 'книг', 'книга',
    'цитат', 'цитаты', 'про смерть', 'про любов', 'про жизнь',
    'трагедия', 'потеряв', 'наркологическ', 'клиник', 'сбегает',
    'возвращается', 'встречает', 'наследство', 'условии', 'поработать',
    'учителем', 'школ', 'подростк', 'закончился', 'разбор', 'концовк',
    'драмеди', 'серий', 'рэпер', 'жизн', 'меняется', 'музыкант',
    'оказывается', 'вскоре', 'родной', 'город', 'старший', 'брат',
    'распоряжении', 'семейное', 'соглашается', 'поделиться', 'общий',
    'язык', 'психологическая', 'восьми', 'минут', 'круто',
    
    # Новые нейтральные слова для звездных новостей
    'конспирации', 'папарацци', 'тайный', 'переезд', 'осваивают искусство',
    'блеском', 'впечатляющих успехов', 'представитель', 'официальный',
    'живут', 'место жительства'
]

# Слова для описания проблем (нейтральные в контексте советов)
PROBLEM_NEUTRAL = [
    'проблем', 'трудност', 'сложност', 'не получается', 'не выходит',
    'не могу', 'не умею', 'как научиться', 'как избавиться',
    'как правильно', 'как сделать', 'почему не', 'почему не получается',
    'не выходит правильно', 'не получается научиться'
]

# ========== УЛУЧШЕННЫЕ КЛЮЧЕВЫЕ СЛОВА ==========

TOPIC_KEYWORDS = {
    "cinema": [
        "кино", "фильм", "сериал", "премьер", "кинопрокат", "съемк", "режиссер", 
        "актер", "актрис", "кинематограф", "кинотеатр", "трейлер", "блокбастер",
        "мультфильм", "анимационн", "постер", "сценарий", "продюсер", "кинокартин",
        "премьера фильма", "премьера сериала", "новый сериал", "новый фильм",
        "роль", "актерск", "в роли", "сыграл", "сыграла", "звездные роли",
        "главная роль", "в главной роли", "историческ", "шпионск", "боевик",
        "онлайн-кинотеатр", "телепремьер", "канал", "действие разворачивается",
        "сюжет", "персонаж", "герой", "историческ шпионск", "хэллоуин",
        "тим бертон", "ножницы", "механический человек", "эдвард руки-ножницы",
        "атмосферн", "неочевидн", "просмотр", "просмотра", "картин",
        "кинолент", "кинофильм", "фильмограф", "реценз", "обзор",
        "на экранах", "выход в прокат", "дата выхода", "релиз",
        "комедийн", "комедийный сериал", "снимался в кино", "на канале",
        "стартует", "сериал", "тнт", "канал тнт", "чем закончился",
        "закончился сериал", "разбор концовки", "концовк", "драмеди",
        "серий", "рэпер", "психологическая драмеди", "урок", "сериал урок",
        "разбор", "рецензия", "обсуждение", "сюжет", "персонажи",
        "актерск состав", "юра борисов", "даниил воробьев", "борисов",
        "воробьев"
    ],
    
    "music": [
        "музык", "песн", "альбом", "концерт", "хит", "сингл", "музыкант",
        "рок", "групп", "певец", "певиц", "вокал", "гитар", "барабан", "композитор",
        "поп-музык", "классическ", "джаз", "фолк", "эстрад", "опер",
        "музыкальн", "инструмент", "оркестр", "хор", "музыкальн конкурс",
        "исполнитель", "аранжировк", "звукозапись", "студий", "минусовк",
        "клип", "видеоклип", "радиоэфир", "чарт", "рейтинг", "популярн",
        "песня", "музыкальный", "музыкальная", "музыкальное"
    ],
    
    "cooking": [
        "рецепт", "готов", "блюдо", "ингредиент", "кухн", "приготовить", "продукт",
        "завтрак", "обед", "ужин", "десерт", "торт", "пирог", "салат", "суп",
        "мясо", "рыб", "овощ", "фрукт", "спец", "приправ", "соус", "маринад",
        "выпечк", "тесто", "начинк", "гарнир", "закуск", "напиток", "коктейл",
        "кулинар", "повар", "столов", "еда", "питание", "диет", "калорийн",
        "пошагов", "инструкц", "способ приготовлен", "быстро", "вкусн",
        "аппетитн", "ароматн", "праздничн", "повседневн", "просто"
    ],
    
    "esoterics": [
        "гороскоп", "сон", "снится", "астролог", "гадани", "ведьм", "обряд",
        "ритуал", "приворот", "оморочка", "магия", "колдовство", "экстрасенс",
        "ясновидящий", "таро", "руны", "астрал", "биоэнергетик", "энергетик",
        "чистка", "порча", "сглаз", "защита", "амулет", "талисман", "оберег",
        "к чему снится", "толкован", "сонник", "приснил", "приснилс", "ведьмак",
        "шаман", "мистик", "эзотерик", "нумеролог", "хиромант", "медитац",
        "к чему снится чернозем", "толкование сн", "значение сна", "предсказа",
        "предсказал", "предсказала", "астрологическ", "гороскоп на",
        "лун", "зодиак", "знак зодиак", "сатурн", "венер", "меркури",
        "марс", "юпитер", "плутон", "нептун", "уран", "созвездие",
        "гадание", "карты", "заговор", "заклинание", "мистическ",
        "сверхъестествен", "паранормальн", "дух", "привидение",
        "мертв", "мертвая", "мертвый", "мертвое", "дохл", "счастлив",
        "тревожн", "паник", "беспоко", "символ", "плодороди", "фертильност",
        "беременност", "насторож", "сонник", "толковател", "знак",
        "предзнаменован", "вещ", "вещий", "вещее", "предсказан", "предвид",
        "смерч", "торнадо", "сновидении", "сновидение", "сновиден", "снится смерч",
        "к чему снится смерч", "толкование сна", "расшифровать", "прорицательниц",
        "болгарской", "прорицательницы", "сюжет", "атмосферное явление",
        "реальной жизни", "задуманные планы", "негативное событие", "предотвратить",
        "невозможно", "детали", "нейтральное", "положительное", "толкование",
        "увиденный", "проекция", "внезапных перемен", "предвестником", "бед",
        "конфликтов", "неурядиц", "рукоприкладства", "опасное", "кувырком",
        "осуществятся", "готовиться", "невозможно",
        # Дополнительные ключевые слова для снов и их толкования
        "поцелуй", "целующаяся пара", "целовать", "целоваться", "видение",
        "толковать поцелуй", "сонник поцелуя", "к чему снится поцелуй",
        # Китайский календарь и астрология
        "китайский календарь", "китайск календарь", "огненная лошадь", "год лошади",
        "красная лошадь", "новый год", "встречать новый год", "привлечь удачу",
        "удача", "год", "лошадь", "дракон", "змея", "кролик", "тигр", "бык",
        "крыса", "свинья", "собака", "коза", "обезьяна", "петух"
    ],
    
    "health": [
        "здоровье", "болезн", "врач", "лечен", "диагноз", "симптом", 
        "лечебн", "применен", "народн", "медицин", "трава", "растен", 
        "свойств", "рецепт", "целебн", "целительн", "мокриц", "звездчатк", 
        "гвоздичн", "профилактик", "иммунитет", "витамин", "минерал",
        "фитнес", "спорт", "йог", "медитац", "релакс", "психолог", 
        "психическ", "терапи", "реабилитац", "больниц", "клиник",
        "косметолог", "косметология", "косметик", "косметическ",
        "уход за кожей", "уход за кож", "кожа", "кож", "комедоны",
        "закрытые комедоны", "очищен", "чистк", "сальные железы",
        "кератолитик", "ретинол", "салициловая кислота", "косметическ средств",
        "косметическ процедур", "бьюти", "бьюти-процедур", "омоложен",
        "омоложени", "процедур", "косметологическ", "маски", "кремы",
        "сыворотк", "лосьон", "тоник", "скраб", "пилинг", "эпиляц",
        "депиляц", "маникюр", "педикюр", "парикмахер", "стилист",
        "визажист", "макияж", "прическа", "уход за волос", "уход за лицом",
        "диет", "похуден", "вес", "лишний вес", "ожирен", "диетолог",
        "питание", "правильное питание", "здоровое питание", "витамины",
        "микроэлемент", "кальций", "железо", "белок", "жир", "углевод",
        "логопед", "логопедическ", "выговаривать", "произношение", "речь",
        "артикуляц", "звук", "буква", "буквы", "дикц", "дикция",
        "упражнен", "логопедическ упражнен", "коррекц", "коррекция речи",
        "дефектолог", "дефектология", "речевой", "речевое развит",
        "фонетик", "фонема", "произносить", "правильное произношение",
        "неправильное произношение", "картав", "шепеляв", "заикание",
        "заика", "запинание", "темп речи", "ритм речи", "голос",
        "дыхание", "речевое дыхание", "фонетическая гимнастик",
        "артикуляционная гимнастик", "язык", "губы", "зубы", "небо",
        "уздечка", "короткая уздечка", "подъязычная уздечка",
        # Дополнительные ключевые слова для косметологии
        "ботокс", "ботулинотерапия", "уколы красоты", "инъекци",
        "эстетической медицине", "омоложения", "мимические морщины",
        "морщины", "возрастные изменени", "филлер", "контурная пластика",
        "мезотерапия", "биоревитализация", "плацентарная терапия",
        "лазер", "фотоомоложение", "пилинг", "чистка лица", "ультразвуковая чистка"
    ],
    
    "fashion": [
        "мода", "стиль", "одежд", "наряд", "платье", "дизайнер", "бренд",
        "стилист", "образ", "образы", "косметик", "косметолог", "косметология",
        "бьюти", "омоложен", "омоложени", "процедур", "бьюти-процедур",
        "косметологическ", "макияж", "прическа", "маникюр", "педикюр",
        "салон", "красот", "уход за кож", "уход за волос", "парфюм",
        "аксессуар", "сумк", "туфл", "обув", "украшен", "бижутери",
        "модн", "тренд", "коллекц", "показ", "неделя мод", "модель",
        "подиум", "гламур", "шик", "элегантност", "гардероб",
        "аутфит", "лук", "стилизац", "визаж", "имидж",
        "трикотаж", "костюм", "пиджак", "юбк", "брюк", "блузк",
        "свитер", "кардиган", "пальто", "куртк", "пуховк",
        "белье", "нижнее белье", "купальник", "пляжн",
        "украшен", "серьг", "кольц", "браслет", "цепочк",
        "часы", "ремен", "галстук", "шарф", "платк", "шапк",
        "перчатк", "зонт", "солнцезащитн очк", "выставк мод",
        "показ мод", "неделя моды", "коллекция одежд", "дизайнер одежд",
        "осень", "зима", "весна", "лето", "сезон", "новинк",
        "прогноз", "модный прогноз", "тренды сезона", "осень зима",
        "весна лето", "капсульн", "базов", "гардероб",
        "стильн", "модниц", "модник", "шопинг", "покупк",
        "распродаж", "скидк", "дисконт", "магазин", "бутик",
        "онлайн-шопинг", "интернет-магазин", "доставк"
    ],
    
    "relationships": [
        "семья", "дети", "брак", "свадьб", "любов", "отношен", "муж", "жена",
        "супруг", "супруга", "родител", "мать", "отец", "ребенок", "детск",
        "воспитан", "взаимоотношен", "дружб", "друг", "подруг", "пар",
        "роман", "свидан", "встреч", "знакомств", "семейн", "домочадц",
        "родительств", "материнств", "отцовств", "бабушк", "дедушк",
        "влюбленност", "чувств", "эмоц", "привязанност", "верност",
        "измен", "ревност", "доверие", "поддержк", "забот", "нежност",
        "невестк", "свекр", "тещ", "зять", "снох", "внук", "внучка",
        "родственник", "семейн жизнь", "личн жизнь", "семейн отношен",
        "супружеск", "супружеск жизнь", "пар", "отношен между",
        "любовн", "любовн отношен", "любовн связ", "романтическ",
        "романтическ отношен", "свидан", "знакомств", "встреча",
        "помолвк", "обручен", "жених", "невест", "молодожен",
        "разобраться в себе", "самоанализ", "психолог", "психическ",
        "эмоциональн", "чувства", "мысли", "проблем", "решен проблем",
        "самосовершенствован", "личностн рост", "самопознан", "саморазвит",
        "совет", "рекомендац", "как построить", "как сохранить",
        "конфликт", "ссор", "примир", "прощен", "прощение",
        "расставан", "развод", "развод", "одиночеств", "одинок",
        "привычк", "привычки", "счастлив", "счастливые", "счастливых",
        "тепл", "атмосфер", "прост", "правил", "работают", "пожелан",
        "совместн", "ужин", "спасибо", "извин", "мелоч", "дом",
        "возвращаться", "возвращаются", "возвращение", "цитат", "цитаты",
        "цитата", "про смерть", "про любов", "про жизнь", "про отношения",
        "горе", "скорб", "печал", "груст", "тоск", "слез", "слезы",
        "плач", "боль", "боли", "утрат", "потер", "памят", "воспоминания",
        "сердце", "сердца", "любимый", "любимая", "любимые", "ушел", "ушла",
        "потерял", "потеряла", "скорблю", "скорбим", "скорбите", "скорбит",
        "брат", "старший брат", "семейное наследство", "общий язык", "подростк"
    ],
    
    "celebrities": [
        "звезд", "знаменитост", "актер", "актрис", "певец", "певиц",
        "артист", "селебрити", "инфлюенсер", "блогер", "медиаперсон", 
        "интервью", "откровен", "признался", "призналась", "рассказал", 
        "рассказала", "поделился", "поделилась", "королевск", "корол", 
        "королев", "принц", "принцесс", "монарх", "аристократ", "дворян", 
        "королевств", "королевск семья", "карл iii", "принц гарри",
        "меган маркл", "камилл", "вестминстерск", "коронац",
        "сергей маковецк", "кирилл кяро", "мариан спив", "роман попов",
        "кейт миддлтон", "уильям", "камилл паркер", "алла пугачев",
        "галкин", "боярск", "линдси лохан", "ана де армас", "том круз",
        "евгений маргулис", "максим матвеев", "елена жуков",
        "звездн", "знаменит", "популярн", "известн", "медийн",
        "медиа", "телеведущ", "радиоведущ", "журналист", "обозревател",
        "критик", "эксперт", "авторитет", "лидер мнен", "блог",
        "соцсет", "инстаграм", "ютуб", "тикток", "подписчик",
        "фанат", "поклонник", "публичн", "публичн личност",
        "медиаперсон", "инфлюенсер", "блогер-миллионник",
        "кристина орбакайте", "кэти перри", "елизавет", "королева елизавет",
        "дворецк", "дворецкий", "гранот харролд", "принц чарльз",
        "брежнев", "леонид брежнев", "вилли брандт", "гарри",
        "уильям", "кейт", "камилла", "анастас", "настя",
        "телеведущ", "ведущ", "шоумен", "комик", "юморист",
        "реалити-шоу", "ток-шоу", "интервьюер", "журналистск",
        "александр робак", "арсений робак", "робак", "мариам халилова",
        "юлия снигирь", "никита ефремов", "никита", "ефремов",
        "снигирь", "халилова", "владимир пресняков", "пресняков",
        "никита пресняков", "владимир", "пресняк", "меган", "маркл",
        "гарри", "книг", "книга", "обретая свободу", "обретая свободу",
        "выход", "выход книги", "новый книга", "книга о", "книги о",
        "юра борисов", "даниил воробьев", "юра", "борисов", "воробьев"
    ],
    
    "entertainment": [
        "развлечен", "досуг", "отдых", "отпуск", "путешеств", "тур", 
        "праздник", "фестивал", "книг", "книжн", "чтение", "читат", 
        "фэнтези", "литературн", "литератур", "преми", "премия", 
        "автор", "писатель", "роман", "повест", "рассказ", "библиотек", 
        "издани", "издательств", "публикац", "театр", "театральн", 
        "спектакл", "постановк", "театральн постановк", "дракон", 
        "фэнтези книг", "фантастик", "детектив", "приключен", "поэзи",
        "стих", "стихотворен", "музей", "галере", "выставк", "парк",
        "аттракцион", "игр", "хобби", "рукодел", "отдыха", "каникул",
        "мероприятие", "событие", "шоу", "концерт", "вечеринк", "тусовк",
        "клуб", "бар", "ресторан", "кафе", "кинотеатр", "цирк", "зоопарк",
        "аквапарк", "парк развлечен", "дискотек", "ночн клуб",
        "подкаст", "радио", "телевидение", "тв", "ютуб", "стрим",
        "трансляц", "онлайн", "интернет", "соцсет", "блог",
        "самое популярное имя", "рейтинг имен", "популярные имен",
        "имя ребенк", "выбор имени", "имен", "назван", "хэллоуин",
        "хеллоуин", "костюм", "маскарад", "карнавал", "украшен",
        "декорац", "празднован", "вечеринк", "ночь", "страшн",
        "атмосферн", "тематическ", "просмотр", "киносеанс",
        "подборк", "рекомендац", "что посмотреть", "что почитать",
        "что послушать", "куда сходить", "куда пойти", "досуг",
        "свободное время", "выходные", "план на выходные",
        "иде", "развлечен", "игр", "настольные игр", "видеоигр",
        "компьютерные игр", "мобильные игр", "приложен",
        "приложение", "мобильное приложение", "гаджет",
        "рассказываем", "рассказ", "анонс", "рейтинг", "ожидаем",
        "премьер", "спектакл", "постановк", "театральн", "цитат",
        "цитаты", "подборк цитат", "цитаты о", "цитаты про",
        "чем закончился", "разбор концовки", "обсуждение сериала",
        "рецензия на сериал", "обзор сериала",
        # Дополнительные ключевые слова для туризма и мероприятий
        "путешеств", "туризм", "каникулы", "отдых", "курорт", 
        "тур", "поездк", "эгейском побережье", "турецкие каникулы",
        "отпуск", "отдыха", "побережье", "путешествен", "турист",
        "достопримечательности", "экскурсия", "турпоездка", "отель",
        "гостиница", "кемпинг", "пляж", "море", "горы", "природа",
        "мероприят", "события", "гид по", "ноябрь без скуки",
        "заряженные события", "интересностей", "научный квест",
        "приключением", "драйвом", "пользой", "фестивал", "выставк",
        "ярмарк", "конференц", "форум", "семинар", "тренинг",
        "мастер-класс", "воркшоп", "интерактив", "квест", "игра",
        "аттракцион", "парк развлечений", "цирк", "зоопарк",
        "аквапарк", "дельфинарий", "океанариум", "музей",
        "галерея", "театр", "кинотеатр", "концерт", "спектакль",
        "шоу", "представление", "перформанс", "инсталляция",
        "детей", "подростков", "детск", "ребенок", "семейн",
        "семейный отдых", "детское мероприятие", "детский праздник",
        "детская программа", "творческ", "развивающ", "образовательн",
        "познавательн", "интеллектуальн", "спортивн", "активн"
    ],
    
    "home": [
        "ремонт", "ремонтн", "отделка", "отделочн", "интерьер", "интерьерн",
        "комнатные растен", "уход за растен", "полив растен", "удобрен растен",
        "мебель", "мебел", "диван", "кровать", "шкаф", "комод", "стол", "стул",
        "уборк", "чистот", "хранен", "организац", "систем хранен", "садоводств",
        "огород", "огородн", "дач", "дачн", "комнат", "балкон", "гардеробн",
        "обои", "обойн", "отклеива", "отклеил", "отклеилс", "переклейк", "клей",
        "пылесос", "стиральн машин", "посудомоечн машин", "холодильник",
        "плит", "микроволновк", "кофеварк", "чайник", "утюг",
        "уборк квартир", "уборк дом", "генеральн уборк", "мыть", "чистк",
        "уют", "комфорт", "освещен", "штор", "занавеск", "ковер", "коврик",
        "телефон", "смартфон", "экран", "защит", "стекло", "пленк", "чехол",
        "техник", "гаджет", "электроник", "бытов", "бытов техник",
        "чайник", "накип", "очистк", "чистк чайник", "уксус", "лимонн кислот",
        "сода", "чистящ", "моющ", "средств", "способ очистк", "проверенн способ",
        "легк", "просто", "быстр", "эффективн", "домашн", "домашн средств",
        "уход за дом", "уход за техник", "уход за бытов техник",
        "хранен вещ", "организац пространств", "порядок в дом",
        "чистота", "гигиен", "санузел", "ванн", "душ", "раковин",
        "унитаз", "смесител", "труб", "канализац", "водопровод",
        "электрика", "розетк", "выключател", "провод", " ламп",
        "отоплен", "батаре", "кондиционер", "вентиляц", "окн",
        "двер", "пол", "стен", "потолок", "крыш", "фундамент",
        "сад", "огород", "грядк", "посадк", "урожай", "полив",
        "удобрен", "компост", "сад техник", "инвентар", "лопат",
        "грабл", "тяпк", "секатор", "лейк", "шланг", "опрыскивател",
        "дом", "квартир", "жиль", "жилое", "недвижимость",
        "ипотек", "аренд", "покупк квартир", "продаж квартир",
        "дизайн интерьера", "интерьерный дизайн", "декор",
        "украшен", "предмет интерьера", "аксессуар для дома",
        "текстиль", "постель", "постельные принадлежност",
        "посуда", "кухонн посуда", "столов прибор", "ножи",
        "кастрюл", "сковород", "чайник", "кофейник", "тостер",
        "блендер", "миксер", "кухонн комбайн"
    ]
}

# ========== ОСНОВНОЙ КЛАСС ==========

class AutoLabeler:
    """Класс для автоматической разметки статей"""
    
    def __init__(self):
        self.stats = Counter()
    
    def detect_sentiment(self, text: str, title: str = "", category: str = "") -> str:
        """
        Определение тональности текста
        
        Args:
            text: текст статьи
            title: заголовок статьи
            category: категория статьи
            
        Returns:
            "positive" или "negative"
        """
        if not text and not title:
            return "positive"
        
        full_text = (title + " " + text).lower()
        category_lower = category.lower() if category else ""
        
        # ========== СПЕЦИАЛЬНЫЕ ПРАВИЛА ДЛЯ ПОЗИТИВНЫХ ТЕМ ==========
        
        # ЯВНО ПОЗИТИВНЫЕ СЛОВА ДЛЯ КОНКРЕТНЫХ КАТЕГОРИЙ
        SPECIAL_POSITIVE_PATTERNS = [
            # Кино и сериалы (премьеры, трейлеры, новые сезоны)
            'премьер', 'премьера', 'премьера фильма', 'премьера сериала', 'премьера трейлера',
            'трейлер', 'новый сезон', 'второй сезон', 'третий сезон', 'новый фильм', 'новый сериал',
            'долгожданн', 'завоевал любовь', 'получил премию', 'топ лучших', 'лучших сериалов',
            'лучших фильмов', 'киноведов', 'кинокритиков', 'белый слон', 'онлайн-кинотеатр',
            'заметных', 'обсуждаемых', 'проектов', 'зрителей', 'критиков', 'ждут',
            'знакомые герои', 'новые лица', 'снялись', 'кинотеатр', 'кинопрокат',
            
            # Туризм и путешествия
            'турецкие каникулы', 'эгейском побережье', 'путешестви', 'отдых', 'отдыха',
            'каникул', 'курорт', 'отпуск', 'тур', 'поездк',
            'ярких впечатлений', 'вдохновляя', 'новые путешествия',
            
            # Праздники и поздравления
            'день отца', 'открыток', 'картинок', 'слов любви', 'благодарности',
            'поздравления', 'поздравить', 'теплых слов', 'добрых открыток',
            'обнять папу', 'спасибо', 'поздравляем', 'с праздником',
            
            # События и мероприятия
            'фестивал', 'театральных искусств', 'открытие', 'торжественное',
            'красную дорожку', 'известных артистов', 'театральных деятелей',
            'мероприят', 'события', 'гид по', 'ноябрь без скуки',
            'заряженные события', 'интересностей', 'научный квест',
            'приключением', 'драйвом', 'пользой',
            
            # Образование и развитие
            'программа', 'мама-предприниматель', 'обучение', 'поддержк',
            'проект', 'участницы', 'женское предпринимательство',
            'развитие', 'поддержка', 'реализуется', 'минэкономразвития',
            
            # Косметология и уход
            'ботокс', 'омоложения', 'уколы красоты', 'красивый результат',
            'естественный результат', 'грамотный подход', 'ботулинотерапия',
            'популярная процедура', 'эстетической медицине', 'косметолог',
            'развенчивает мифы', 'врач-косметолог',
            
            # Звездные новости (позитивные)
            'переезд', 'новое место жительства', 'осваивают искусство', 'впечатляющих успехов',
            'блеском', 'тайный переезд', 'конспирация', 'папарацци', 'представитель',
            'официальный', 'живут', 'санта барбара', 'беверли хиллз', 'лос-анджелес',
            'калифорнийских',
            
            # Общие позитивные паттерны
            'топ-10', 'топ 10', 'рекомендац', 'совет', 'лучшие', 'новинк',
            'подарк', 'сюрприз', 'радост', 'счастлив', 'успех', 'победа',
            'достижение', 'развитие', 'улучшение', 'помощь', 'поддержка',
            'вдохновен', 'интересн', 'познавательн', 'образовательн',
            'полезн', 'эффективн', 'красив', 'привлекательн', 'модн',
            'тренд', 'стильн', 'элегантн', 'шикарн', 'роскошн',
            'гламурн', 'обворожительн', 'очаровательн', 'неотразим',
            'обаятельн', 'доброжелательн', 'талант', 'талантлив',
            'уникальн', 'невероятн', 'историческ значим', 'масштабн',
            'легк', 'просто', 'быстр', 'весел', 'весело',
            'интересн', 'познавательн', 'образовательн',
            'развива', 'развитие', 'совершенствован', 'улучшен',
            'обновлен', 'новинк', 'новшеств', 'инновац', 'модерн',
            'современн', 'ценный', 'ценный опыт', 'радость',
            'добр', 'добрый', 'тепл', 'доверие', 'свобод',
            'свобода', 'любимый', 'любимая', 'воспоминания',
            'память', 'сердце', 'любви', 'сокровище'
        ]
        
        # Проверка на специальные позитивные паттерны
        has_special_positive = any(pattern in full_text for pattern in SPECIAL_POSITIVE_PATTERNS)
        
        # Если есть явные позитивные паттерны для досуга, туризма, праздников, звезд, кино - сразу позитив
        if category_lower in ['entertainment', 'relationships', 'celebrities', 'cinema'] and has_special_positive:
            return "positive"
        
        # Проверка на особые случаи по заголовкам
        title_lower = title.lower() if title else ""
        
        # Тематические статьи с явно позитивным содержанием
        if any(phrase in title_lower for phrase in [
            'каникулы', 'праздник', 'день отца', 'открытки', 'картинки',
            'новинки', 'фестиваль', 'мероприятия', 'события', 'гид по',
            'программа', 'обучение', 'поддержка', 'развитие',
            'ботокс', 'омоложение', 'уход за', 'топ-10', 'топ 10',
            'переезд', 'тайный переезд', 'меган маркл', 'принц гарри'
        ]):
            # Проверяем, нет ли явного негатива в контексте
            strong_negative_context = any(word in full_text for word in [
                'смерть', 'скандал', 'конфликт', 'проблем', 'трудност',
                'кризис', 'увольнение', 'развод', 'ссор', 'вражд',
                'обвинен', 'суд', 'иск', 'подал иск'
            ])
            if not strong_negative_context:
                return "positive"
        
        # Проверка явных негативных маркеров
        has_strong_negative = False
        negative_context = False
        
        for word in STRONG_NEGATIVE:
            if word in full_text:
                # Проверяем, не является ли это контекстом описания фильма/книги
                if word in NEUTRAL_IN_CONTEXT:
                    # Проверяем, есть ли контекст фильма/книги
                    if any(context_word in full_text for context_word in ["фильм", "сериал", "кино", "книг", "книга", "роман", "сюжет", "спектакл", "пьеса", "постановка"]):
                        negative_context = True
                        continue  # Пропускаем, это описание сюжета
                
                # Проверяем, не является ли это описанием проблемы для совета
                if any(problem_word in full_text for problem_word in PROBLEM_NEUTRAL):
                    # Если это описание проблемы в контексте совета/помощи
                    if category_lower in ['health', 'home', 'relationships']:
                        if any(help_word in full_text for help_word in ['совет', 'рекомендац', 'как', 'помощь', 'упражнен', 'способ', 'привычк', 'правил']):
                            continue  # Пропускаем, это описание проблемы для совета
                
                # Для гороскопов/эзотерики даже негативные слова - не негатив, а предсказание
                if category_lower == 'esoterics':
                    if any(esoteric_word in full_text for esoteric_word in ['к чему снится', 'сон', 'снится', 'толкование', 'значение сна', 'сонник', 'предсказание']):
                        continue  # Пропускаем, это толкование сна
                
                # Для цитат о смерти - это все равно негатив
                if 'цитат' in full_text and 'смерть' in full_text:
                    # Это явный негативный контекст
                    has_strong_negative = True
                    break
                
                has_strong_negative = True
                break
        
        # Проверка явных позитивных маркеров
        has_strong_positive = False
        positive_words_count = 0
        for word in STRONG_POSITIVE:
            if word in full_text:
                has_strong_positive = True
                positive_words_count += 1
        
        # Правила для разных категорий
        
        # 1. Развлечения, Досуг - почти всегда позитивные
        if category_lower in ['entertainment']:
            if has_strong_negative and not negative_context:
                # Исключение: если это действительно скандал или конфликт
                scandal_words = ['скандал', 'конфликт', 'обидно', 'несправедливо', 
                               'лишили', 'нелепый', 'поразила', 'выходка',
                               'швырнула', 'потрясла', 'судиться', 'суд', 'иск']
                has_scandal = any(word in full_text for word in scandal_words)
                if has_scandal:
                    return "negative"
                else:
                    return "positive"
            else:
                # Для развлечений по умолчанию позитив
                return "positive"
        
        # 2. Отношения - обычно позитивные, особенно про праздники
        if category_lower == 'relationships':
            # Проверяем контекст праздников и положительных событий
            positive_context_words = ['день отца', 'открытк', 'картинк', 'поздравлени',
                                     'любви', 'благодарности', 'теплых', 'добрых',
                                     'семья', 'семейн', 'радост', 'счастлив']
            has_positive_context = any(word in full_text for word in positive_context_words)
            
            if has_positive_context and not has_strong_negative:
                return "positive"
            
            if has_strong_negative:
                # Проверяем, это описание проблемы для совета или реальный негатив
                if any(help_word in full_text for help_word in ['совет', 'рекомендац', 'как', 'помощь']):
                    return "positive"  # Совет по решению проблемы
                else:
                    return "negative"  # Реальный негативный случай
            else:
                return "positive"
        
        # 3. Кино и Развлечения - обычно позитивные (кроме скандалов)
        if category_lower in ['cinema', 'entertainment']:
            # Для кино: премьеры, трейлеры, новые сезоны - всегда позитивные
            cinema_positive_keywords = [
                'премьер', 'премьера', 'премьера фильма', 'премьера сериала', 'премьера трейлера',
                'трейлер', 'новый сезон', 'второй сезон', 'третий сезон', 'новый фильм', 'новый сериал',
                'долгожданн', 'завоевал любовь', 'получил премию', 'топ лучших', 'лучших сериалов',
                'лучших фильмов', 'киноведов', 'кинокритиков', 'белый слон', 'онлайн-кинотеатр',
                'заметных', 'обсуждаемых', 'проектов', 'зрителей', 'критиков', 'ждут',
                'знакомые герои', 'новые лица', 'снялись', 'кинотеатр', 'кинопрокат',
                'состоялась премьера', 'продолжен', 'сериал', 'кино'
            ]
            has_cinema_positive = any(keyword in full_text for keyword in cinema_positive_keywords)
            
            if has_cinema_positive:
                # Для премьер и положительных новостей о кино - всегда позитив
                return "positive"
            
            if has_strong_negative and not negative_context:
                # Проверяем, это скандал или просто описание сюжета
                scandal_words = ['скандал', 'конфликт', 'обидно', 'несправедливо', 'лишили', 
                                'нелепый', 'поразила', 'выходка', 'швырнула', 'потрясла',
                                'судиться', 'суд', 'иск', 'жалоб', 'критик', 'разоблачен',
                                'унизительн', 'унижен', 'стыд', 'сочувств', 'жалост', 'злорадств']
                has_scandal = any(word in full_text for word in scandal_words)
                if has_scandal:
                    return "negative"
                else:
                    # Для описаний сюжетов - позитивная тональность
                    return "positive"
            else:
                return "positive"
        
        # 4. Звезды - часто позитивные, кроме явных скандалов и болезней
        if category_lower == 'celebrities':
            # Проверяем на болезни и проблемы со здоровьем звезд
            illness_words = ['болезн', 'заболел', 'заболела', 'заболели', 'болеет', 'болеют',
                           'недуг', 'недугом', 'лежит', 'лечится', 'лечение', 'лечат',
                           'лекарств', 'аптек', 'врач', 'больниц', 'клиник', 'симптом',
                           'опухш', 'опухла', 'раскрыла подробности своей болезни',
                           'столкнулась', 'невозможность', 'невзгоды', 'проблем']
            has_illness = any(word in full_text for word in illness_words)
            
            if has_illness:
                return "negative"  # Болезни звезд - негативная тональность
            
            # Проверяем на явные скандальные слова
            scandal_words = ['скандал', 'конфликт', 'обидно', 'несправедливо', 'лишили',
                           'судиться', 'суд', 'иск', 'жалоб', 'критик', 'разоблачен',
                           'унизительн', 'унижен', 'стыд', 'сочувств', 'жалост', 'злорадств']
            has_scandal = any(word in full_text for word in scandal_words)
            
            if has_scandal:
                return "negative"
            elif has_strong_negative:
                # Проверяем, не является ли это описанием работы/проекта
                work_context_words = ['проект', 'фильм', 'сериал', 'роль', 'актер', 'режиссер', 'съемк', 'книг', 'книга']
                has_work_context = any(word in full_text for word in work_context_words)
                if has_work_context:
                    return "positive"  # Описание работы актера/книги
                return "negative"
            elif has_strong_positive:
                return "positive"
            else:
                # Для звезд по умолчанию нейтральная/позитивная
                return "positive"
        
        # 5. Мода - обычно позитивная (советы, тренды)
        if category_lower == 'fashion':
            if has_strong_negative:
                # Но если есть явные негативные оценки (критика внешности)
                negative_fashion = ['нелепый', 'не по возрасту', 'неприятно', 'поразила', 'странный', 'дикий']
                if any(word in full_text for word in negative_fashion):
                    return "negative"
                else:
                    return "positive"
            else:
                return "positive"
        
        # 6. Здоровье - обычно позитивная (советы, рекомендации)
        if category_lower == 'health':
            # Даже если есть "проблема" - это описание для совета
            return "positive"
        
        # 7. Эзотерика - всегда позитивная (даже "предупреждает" - это нейтрально)
        if category_lower == 'esoterics':
            return "positive"
        
        # 8. Быт, Кулинария, Музыка - обычно позитивные
        if category_lower in ['home', 'cooking', 'music']:
            # Но для цитат о смерти - негатив
            if 'цитат' in full_text and 'смерть' in full_text:
                return "negative"
            return "positive"
        
        # Общее правило
        if has_strong_negative:
            # Если есть много позитивных слов в контексте смерти (как в цитатах), 
            # все равно это негативная тема
            if 'смерть' in full_text or 'горе' in full_text or 'утрат' in full_text:
                return "negative"
            return "negative"
        elif has_strong_positive:
            return "positive"
        else:
            # По умолчанию для лайфстайл-сайта - позитивная тональность
            return "positive"
    
    def detect_category(self, original_category: str, text: str = "", title: str = "") -> str:
        """
        Определение основной категории статьи
        
        Returns:
            основная категория (тема) на английском
        """
        # Шаг 1: Маппинг исходной категории
        if original_category:
            original_lower = original_category.lower().strip()
            if original_lower in CATEGORY_MAPPING:
                mapped_category = CATEGORY_MAPPING[original_lower]
                
                # Фиксированные маппинги
                if original_lower == "гороскопы":
                    return "esoterics"
                elif original_lower == "кино":
                    # Для "Кино" проверяем, о звездах ли статья
                    full_text = (title + " " + text).lower()
                    
                    # Если статья о конкретных актерах/звездах
                    celebrities_keywords = ["актер", "актрис", "певец", "певиц", "артист", "звезд", 
                                          "знаменитост", "робак", "халилова", "снигирь", "ефремов", "меган", "маркл",
                                          "юра борисов", "даниил воробьев", "борисов", "воробьев"]
                    if any(keyword in full_text for keyword in celebrities_keywords):
                        # Но если это описание съемок/проекта
                        cinema_keywords = ["кино", "фильм", "сериал", "съемк", "режиссер", "роль", "канал", "чем закончился", "разбор концовки"]
                        if any(keyword in full_text for keyword in cinema_keywords):
                            # И там есть имена актеров - это все равно кино
                            return "cinema"
                        else:
                            return "celebrities"
                    else:
                        return "cinema"
                elif original_lower == "стиль":
                    # Для "Стиль" проверяем контекст - косметология или мода
                    full_text = (title + " " + text).lower()
                    
                    # СТРОГАЯ ПРОВЕРКА ДЛЯ КОСМЕТОЛОГИИ И БОТОКСА (только медицинский контекст)
                    # Исключаем общие слова, которые могут быть в модных статьях
                    health_keywords_strict = [
                        "косметолог", "косметология", "ботокс", "ботулинотерапия", 
                        "уколы красоты", "инъекци", "эстетической медицине", 
                        "врач-косметолог", "омоложения", "мимические морщины", 
                        "возрастные изменени", "комедоны", "сальные железы", 
                        "кератолитик", "ретинол", "салициловая кислота"
                    ]
                    
                    # Проверяем наличие медицинского/косметологического контекста
                    medical_context_words = ["врач", "клиническ", "медицин", "терапия", 
                                           "лечен", "процедур", "клиник", "бьюти-процедур",
                                           "омоложен", "чистк лица", "уход за кожей"]
                    
                    # Проверяем модные ключевые слова (одежда, аксессуары, стиль)
                    fashion_keywords = ["одежд", "наряд", "платье", "костюм", "юбк", 
                                       "брюк", "пиджак", "куртк", "пальто", "сумк", 
                                       "туфл", "обув", "аксессуар", "украшен", "кольц",
                                       "серьг", "браслет", "тартан", "клетк", "принт",
                                       "модн", "тренд", "стильн", "образ", "лук", "аутфит",
                                       "гардероб", "коллекц", "дизайнер", "бренд"]
                    
                    # Если есть строгие медицинские ключевые слова И медицинский контекст
                    has_strict_health = any(keyword in full_text for keyword in health_keywords_strict)
                    has_medical_context = any(word in full_text for word in medical_context_words)
                    
                    # Если есть модные ключевые слова (одежда, аксессуары, стиль)
                    has_fashion_context = any(keyword in full_text for keyword in fashion_keywords)
                    
                    # Только если есть строгие медицинские слова И медицинский контекст, И нет модного контекста
                    if has_strict_health and has_medical_context and not has_fashion_context:
                        return "health"
                    else:
                        # По умолчанию для категории "Стиль" - это мода
                        return "fashion"
                elif original_lower == "звезды":
                    return "celebrities"
                elif original_lower == "досуг":
                    # Для "Досуг" проверяем, что именно
                    full_text = (title + " " + text).lower()
                    
                    # Кино
                    cinema_keywords = ["кино", "фильм", "сериал", "премьер", "режиссер", "актер", "чем закончился", "разбор концовки"]
                    if any(keyword in full_text for keyword in cinema_keywords):
                        return "cinema"
                    
                    # Театр
                    theater_keywords = ["театр", "спектакл", "постановк", "пьес", "драматург"]
                    if any(keyword in full_text for keyword in theater_keywords):
                        return "entertainment"
                    
                    # Книги
                    book_keywords = ["книг", "роман", "автор", "писатель", "литератур"]
                    if any(keyword in full_text for keyword in book_keywords):
                        return "entertainment"
                    
                    # Цитаты
                    quote_keywords = ["цитат", "цитаты", "цитата", "про смерть", "про любов", "про жизнь"]
                    if any(keyword in full_text for keyword in quote_keywords):
                        return "entertainment"
                    
                    # Путешествия
                    travel_keywords = ["путешеств", "туризм", "каникулы", "отдых", "курорт", "отпуск"]
                    if any(keyword in full_text for keyword in travel_keywords):
                        return "entertainment"
                    
                    return "entertainment"
                elif original_lower == "здоровье":
                    return "health"
                elif original_lower == "мой дом":
                    # Для "Мой дом" анализируем контекст
                    full_text = (title + " " + text).lower()
                    
                    # ПРИОРИТЕТ 1: Проверяем здоровье (лечебные травы, растения, народная медицина)
                    health_keywords_medicinal = [
                        "мокриц", "звездчатк", "лечебн", "лечебные свойства", "применен", 
                        "народн", "народная медицина", "медицин", "трава", "растен",
                        "целебн", "целительн", "активные вещества", "регенерац", "стимулируют",
                        "цинк", "железо", "магний", "каротин", "флавоноид", "дубильн",
                        "лечен", "болезн", "симптом", "диагноз", "врач", "применяется при"
                    ]
                    if any(keyword in full_text for keyword in health_keywords_medicinal):
                        return "health"
                    
                    # Проверяем здоровье (логопедия и т.п.)
                    health_keywords = ["логопед", "логопедическ", "выговаривать", "произношение", "речь", 
                                     "артикуляц", "звук", "буква", "буквы", "дикц", "коррекц речи",
                                     "дефектолог", "фонетик", "картав", "шепеляв"]
                    if any(keyword in full_text for keyword in health_keywords):
                        return "health"
                    
                    # ПРИОРИТЕТ 2: Проверяем работу и карьеру (резюме, собеседование)
                    career_keywords = ["резюме", "собеседование", "работодатель", "работа", "карьер",
                                      "соискатель", "ваканс", "трудоустройств", "професси", "должност",
                                      "найм", "нанять", "пригласили", "пригласить", "поиск работы",
                                      "первая работа", "фрилансер", "продвижение услуг", "продающий текст"]
                    if any(keyword in full_text for keyword in career_keywords):
                        return "relationships"  # Карьера относится к отношениям/саморазвитию
                    
                    # Проверяем эзотерику (только если нет карьеры)
                    esoterics_keywords = ["сон", "снится", "гороскоп", "астролог", "обряд", "ритуал", "маги", "гадани", "к чему снится"]
                    if any(keyword in full_text for keyword in esoterics_keywords):
                        return "esoterics"
                    
                    # Проверяем кулинарию
                    cooking_keywords = ["рецепт", "готов", "блюдо", "кухн", "приготовить", "продукт", "еда"]
                    if any(keyword in full_text for keyword in cooking_keywords):
                        return "cooking"
                    
                    # Проверяем быт
                    home_keywords = ["чайник", "чистк", "уборк", "ремонт", "мебель", "бытов", "дом", "квартир"]
                    if any(keyword in full_text for keyword in home_keywords):
                        return "home"
                    
                    # Проверяем отношения (включая цитаты о смерти и любви)
                    relationships_keywords = ["семья", "дети", "брак", "любов", "отношен", "психолог", "супруг",
                                            "привычк", "счастлив", "тепл", "доверие", "поддержк",
                                            "цитат", "цитаты", "про смерть", "про любов", "горе", "скорб",
                                            "печал", "груст", "слез", "слезы", "плач", "боль", "утрат", "потер"]
                    if any(keyword in full_text for keyword in relationships_keywords):
                        return "relationships"
                    
                    # По умолчанию
                    return "relationships"
                elif original_lower == "новости":
                    # Для "Новости" анализируем контекст
                    full_text = (title + " " + text).lower()
                    
                    # ПРИОРИТЕТ 1: Проверяем имена звезд и знаменитостей (самый высокий приоритет)
                    celebrities_names = [
                        "линдси лохан", "лохан", "меган маркл", "маркл", "гарри", 
                        "кейт", "уильям", "принц", "принцесс", "пресняков", 
                        "робак", "халилова", "снигирь", "ефремов", "борисов", "воробьев",
                        "пугачев", "галкин", "орбакайте", "перри", "ана де армас",
                        "том круз", "маргулис", "матвеев", "жуков", "маковецк", "кяро",
                        "спив", "попов", "камилл", "карл iii", "брежнев", "брандт",
                        # Добавляем больше имен звезд
                        "проскуряков", "юлия проскуряков", "проскурякова",
                        "лазарев", "сергей лазарев",
                        "клава кока", "кока", "воробьев", "александра воробьев",
                        "чумаков", "алексей чумаков", "куртуков", "татьяна куртуков",
                        "иванов", "татьяна иванов", "комбинация",
                        "романов", "георгий романов", "виктория романова", "александр романов",
                        "мария владимировна", "великая княгиня", "наследник", "династия романовых",
                        "романова", "императорск", "князь", "княгиня"
                    ]
                    
                    # Проверяем наличие имен звезд
                    has_celebrity_name = any(name in full_text for name in celebrities_names)
                    
                    # ПРИОРИТЕТ 2: Проверяем общие слова о звездах, артистах, музыкантах
                    celebrities_keywords = [
                        "звезд", "знаменитост", "актер", "певец", "певиц", 
                        "артист", "артистка", "королевск", "селебрити", "инфлюенсер", 
                        "блогер", "медиаперсон", "эстрад", "музыкант", "рокерш",
                        "преми", "граммофон", "золотой граммофон", "церемони", "вручен",
                        "статуэтк", "дебютант", "рекордсмен", "музыкальн итог"
                    ]
                    has_celebrity_keyword = any(keyword in full_text for keyword in celebrities_keywords)
                    
                    # Если есть имя звезды ИЛИ есть ключевые слова о звездах - приоритет звездам
                    if has_celebrity_name or has_celebrity_keyword:
                        return "celebrities"
                    
                    # ПРИОРИТЕТ 3: Проверяем музыку (музыкальные премии, концерты)
                    music_keywords = [
                        "музык", "песн", "альбом", "концерт", "хит", "сингл", "музыкант",
                        "поп-музык", "эстрад", "музыкальн", "преми", "граммофон",
                        "золотой граммофон", "церемони", "вручен", "статуэтк",
                        "музыкальн итог", "итог года", "юбилейн", "дебютант", "рекордсмен"
                    ]
                    has_music = any(keyword in full_text for keyword in music_keywords)
                    if has_music:
                        # Если есть имена музыкантов - это звезды, иначе музыка
                        if has_celebrity_name:
                            return "celebrities"
                        return "music"
                    
                    # ПРИОРИТЕТ 4: Проверяем эзотерику (только явные маркеры, строго)
                    esoterics_keywords_strong = [
                        "китайский календарь", "китайск календарь", "огненная лошадь", "год лошади",
                        "красная лошадь", "встречать новый год", "привлечь удачу",
                        "гороскоп", "астролог", "предсказа", "маги", "ритуал", 
                        "толкован", "к чему снится", "сон", "снится", "сонник"
                    ]
                    # Исключаем общие слова "год", "удача" без контекста
                    has_esoterics = any(keyword in full_text for keyword in esoterics_keywords_strong)
                    if has_esoterics:
                        # Дополнительная проверка: если есть явный контекст эзотерики
                        esoterics_context = any(phrase in full_text for phrase in [
                            "китайский календарь", "огненная лошадь", "год лошади",
                            "гороскоп на", "астролог", "к чему снится"
                        ])
                        if esoterics_context:
                            return "esoterics"
                    
                    # Проверяем моду
                    fashion_keywords = ["мода", "стиль", "тренд", "образ", "наряд", "платье", "сумк"]
                    if any(keyword in full_text for keyword in fashion_keywords):
                        return "fashion"
                    
                    # Проверяем отношения
                    relationships_keywords = ["семья", "дети", "брак", "любов", "отношен", "супруг", "измен",
                                            "развод", "сын", "дочь", "родител"]
                    if any(keyword in full_text for keyword in relationships_keywords):
                        # Но если это о звездах, то все равно звезды
                        if has_celebrity_name or has_celebrity_keyword:
                            return "celebrities"
                        return "relationships"
                    
                    # По умолчанию
                    return "celebrities"
                
                return mapped_category
        
        # Шаг 2: Если маппинга нет, определяем по ключевым словам
        full_text = (title + " " + text).lower()
        
        category_scores = {}
        
        for category, keywords in TOPIC_KEYWORDS.items():
            score = 0
            for keyword in keywords:
                if keyword in full_text:
                    score += 1
            if score > 0:
                category_scores[category] = score
        
        if category_scores:
            max_category = max(category_scores.items(), key=lambda x: x[1])[0]
            return max_category
        
        return "entertainment"
    
    def detect_multilabel_topics(self, text: str, title: str = "", original_category: str = "") -> List[str]:
        """
        Определение нескольких тем для многометочной классификации
        
        Returns:
            список тем на английском (максимум 2 темы)
        """
        title_lower = title.lower() if title else ""
        text_lower = text.lower() if text else ""
        full_text = (title_lower + " " + text_lower).lower()
        
        # Определяем основную категорию
        main_category = self.detect_category(original_category, text, title)
        
        # Подсчитываем совпадения для каждой темы
        topic_scores = {}
        
        for topic, keywords in TOPIC_KEYWORDS.items():
            score = 0
            # Учитываем наличие ключевых слов
            for keyword in keywords:
                # Ключевое слово в заголовке имеет больший вес
                if keyword in title_lower:
                    score += 3
                # Ключевое слово в тексте
                if keyword in text_lower:
                    score += 1
            if score > 0:
                topic_scores[topic] = score
        
        # ОСНОВНОЕ ПРАВИЛО: Основная тема всегда должна быть первой и иметь самый высокий вес
        if main_category not in topic_scores:
            topic_scores[main_category] = 20  # Очень высокий вес для основной темы
        else:
            topic_scores[main_category] += 15  # Существенно увеличиваем вес основной темы
        
        # Специальные правила
        
        # 1. Для категории "Кино" - усилить кино и ослабить отношения (если нет сильных маркеров)
        if main_category == "cinema":
            if "cinema" in topic_scores:
                topic_scores["cinema"] += 10
            
            # Ослабляем отношения для кино, если нет сильных маркеров семьи
            strong_relationships = ["семья", "брак", "дети", "родител", "супруг", "жена", "муж", 
                                  "любов", "роман", "развод", "измен", "отношен"]
            if "relationships" in topic_scores:
                # Если есть маркеры кино и слабые маркеры отношений
                if "кино" in full_text or "фильм" in full_text or "сериал" in full_text:
                    if not any(word in full_text for word in strong_relationships):
                        topic_scores["relationships"] = max(0, topic_scores["relationships"] - 5)
        
        # 2. Для категории "Эзотерика" - усилить эзотерику и ослабить отношения
        if main_category == "esoterics":
            if "esoterics" in topic_scores:
                topic_scores["esoterics"] += 15
            
            # Ослабляем отношения для эзотерики
            if "relationships" in topic_scores:
                topic_scores["relationships"] = max(0, topic_scores["relationships"] - 10)
            
            # Для снов и толкований - только эзотерика
            if "к чему снится" in full_text or ("сон" in full_text and "толкование" in full_text):
                if "esoterics" in topic_scores:
                    topic_scores["esoterics"] += 20
                
                # Сильно ослабляем отношения для снов
                if "relationships" in topic_scores:
                    topic_scores["relationships"] = max(0, topic_scores["relationships"] - 15)
        
        # 3. Цитаты о смерти → Отношения, а не Эзотерика
        if 'цитат' in full_text or 'цитаты' in full_text or 'цитата' in full_text:
            if 'смерть' in full_text or 'горе' in full_text or 'утрат' in full_text:
                if "relationships" in topic_scores:
                    topic_scores["relationships"] += 10
                else:
                    topic_scores["relationships"] = 8
                
                # Сильно ослабляем эзотерику для цитат о смерти
                if "esoterics" in topic_scores:
                    topic_scores["esoterics"] = max(0, topic_scores["esoterics"] - 10)
                
                # Усиливаем развлечения для подборок цитат
                if "entertainment" in topic_scores:
                    topic_scores["entertainment"] += 5
        
        # 4. Статьи о сериалах (разбор концовки) → Кино, а не Отношения
        if ("чем закончился" in full_text or "разбор концовки" in full_text or 
            "концовк" in full_text) and ("сериал" in full_text or "фильм" in full_text):
            
            if "cinema" in topic_scores:
                topic_scores["cinema"] += 10
            
            # Ослабляем отношения для таких статей
            if "relationships" in topic_scores:
                topic_scores["relationships"] = max(0, topic_scores["relationships"] - 5)
        
        # 5. Сны и толкования → Эзотерика, а не Отношения
        if ("к чему снится" in full_text or "сон" in full_text or "снится" in full_text) and ("толкование" in full_text or "сонник" in full_text):
            
            if "esoterics" in topic_scores:
                topic_scores["esoterics"] += 12
            
            # Ослабляем отношения для снов
            if "relationships" in topic_scores and main_category != "relationships":
                topic_scores["relationships"] = max(0, topic_scores["relationships"] - 8)
        
        # 6. Косметология → Здоровье (не Мода) - только при медицинском контексте
        health_keywords_strict = ["косметолог", "косметология", "ботокс", "ботулинотерапия",
                                 "уколы красоты", "инъекци", "эстетической медицине",
                                 "врач-косметолог", "комедоны", "сальные железы",
                                 "кератолитик", "ретинол", "салициловая кислота",
                                 "логопед", "логопедическ", "выговаривать", "произношение", 
                                 "речь", "артикуляц"]
        medical_context_words = ["врач", "клиническ", "медицин", "терапия", "лечен", 
                                "процедур", "клиник", "бьюти-процедур", "омоложен",
                                "чистк лица", "уход за кожей"]
        
        # Проверяем модные ключевые слова (одежда, аксессуары)
        fashion_context_words = ["одежд", "наряд", "платье", "костюм", "юбк", "брюк",
                                "пиджак", "куртк", "пальто", "сумк", "туфл", "обув",
                                "аксессуар", "украшен", "кольц", "серьг", "браслет",
                                "тартан", "клетк", "принт", "модн", "тренд", "стильн",
                                "образ", "лук", "гардероб", "коллекц", "дизайнер", "бренд"]
        
        has_strict_health = any(keyword in full_text for keyword in health_keywords_strict)
        has_medical_context = any(word in full_text for word in medical_context_words)
        has_fashion_context = any(word in full_text for word in fashion_context_words)
        
        # Только если есть строгие медицинские слова И медицинский контекст, И нет модного контекста
        if has_strict_health and has_medical_context and not has_fashion_context:
            if "health" in topic_scores:
                topic_scores["health"] += 10
            
            # Уменьшаем моду для косметологии
            if "fashion" in topic_scores and main_category != "fashion":
                topic_scores["fashion"] = max(0, topic_scores["fashion"] - 5)
        
        # 7. Звезды + Кино → обе темы для статей о кино со звездами
        if ("актер" in full_text or "актрис" in full_text or "певец" in full_text or 
            "артист" in full_text or "звезд" in full_text) and ("кино" in full_text or 
            "фильм" in full_text or "сериал" in full_text):
            
            # Усиливаем обе темы, но основная остается основной
            if "celebrities" in topic_scores and main_category != "celebrities":
                topic_scores["celebrities"] += 3
            
            if "cinema" in topic_scores and main_category != "cinema":
                topic_scores["cinema"] += 3
            
            # Ослабляем отношения, если нет сильных маркеров семьи
            strong_relationships = ["семья", "брак", "дети", "родител", "супруг", "жена", "муж", 
                                  "любов", "роман", "развод", "измен"]
            if "relationships" in topic_scores and main_category != "relationships" and not any(word in full_text for word in strong_relationships):
                topic_scores["relationships"] = max(0, topic_scores["relationships"] - 3)
        
        # 8. Звезды в новостях → только Звезды (если это основная тема)
        if main_category == "celebrities":
            if "celebrities" in topic_scores:
                topic_scores["celebrities"] += 10
            
            # Уменьшаем моду для звезд, если это просто новости о звезде (не о моде)
            celebrities_names = [
                "линдси лохан", "лохан", "меган маркл", "маркл", "гарри",
                "кейт", "уильям", "пресняков", "робак", "халилова", "снигирь",
                "ефремов", "борисов", "воробьев", "пугачев", "галкин",
                "проскуряков", "проскурякова", "лазарев", "клава кока", "кока",
                "воробьев", "чумаков", "куртуков", "иванов", "романов", "романова"
            ]
            has_celebrity_name = any(name in full_text for name in celebrities_names)
            
            # Если есть имя звезды, но нет явного модного контекста (статья о стиле/одежде)
            fashion_article_keywords = ["мода", "стиль", "тренд", "образ", "наряд", "платье",
                                      "гардероб", "коллекц", "дизайнер", "бренд", "тартан",
                                      "клетк", "принт", "модн", "стильн"]
            has_fashion_article_context = any(keyword in full_text for keyword in fashion_article_keywords)
            
            # Если это новости о звезде (есть имя), но не статья о моде - убираем моду
            if has_celebrity_name and not has_fashion_article_context:
                if "fashion" in topic_scores and main_category != "fashion":
                    topic_scores["fashion"] = max(0, topic_scores["fashion"] - 10)
                
                # Также убираем отношения, если нет сильных маркеров семьи
                strong_relationships = ["семья", "брак", "дети", "родител", "супруг", "жена", "муж",
                                      "любов", "роман", "развод", "измен", "сын", "дочь"]
                if "relationships" in topic_scores and main_category != "relationships":
                    if not any(word in full_text for word in strong_relationships):
                        topic_scores["relationships"] = max(0, topic_scores["relationships"] - 10)
            
            # Сильно убираем эзотерику для звезд (новости о звездах не должны быть эзотерикой)
            if "esoterics" in topic_scores:
                # Только если нет явных маркеров эзотерики (гороскопы, сны)
                esoterics_markers = ["китайский календарь", "огненная лошадь", "год лошади",
                                    "гороскоп", "астролог", "к чему снится", "сон", "снится"]
                has_esoterics_markers = any(marker in full_text for marker in esoterics_markers)
                if not has_esoterics_markers:
                    topic_scores["esoterics"] = max(0, topic_scores["esoterics"] - 20)
            
            # Для музыкальных премий добавляем музыку как вторую тему
            music_premium_keywords = [
                "преми", "граммофон", "золотой граммофон", "церемони", "вручен",
                "статуэтк", "музыкальн итог", "итог года", "юбилейн", "дебютант",
                "рекордсмен", "музыкант", "певец", "певиц", "эстрад"
            ]
            if any(keyword in full_text for keyword in music_premium_keywords):
                if "music" in topic_scores:
                    topic_scores["music"] += 8
        
        # 9. Косметология и ботокс → Здоровье, а не Мода (если нет модного контекста)
        cosmetic_keywords = ["ботокс", "ботулинотерапия", "косметолог", "косметология", 
                            "омоложен", "процедур", "уход за кожей", "инъекци",
                            "мимические морщины", "морщины", "возрастные изменени",
                            "эстетической медицине", "врач-косметолог"]
        
        # Проверяем модные ключевые слова (одежда, аксессуары, стиль)
        fashion_context_words = ["одежд", "наряд", "платье", "костюм", "юбк", "брюк",
                                "пиджак", "куртк", "пальто", "сумк", "туфл", "обув",
                                "аксессуар", "украшен", "кольц", "серьг", "браслет",
                                "тартан", "клетк", "принт", "модн", "тренд", "стильн",
                                "образ", "лук", "гардероб", "коллекц", "дизайнер", "бренд"]
        
        has_cosmetic = any(keyword in full_text for keyword in cosmetic_keywords)
        has_fashion_context = any(word in full_text for word in fashion_context_words)
        
        # Если есть косметологические слова, но нет модного контекста (одежда, аксессуары)
        if has_cosmetic and not has_fashion_context:
            if "health" in topic_scores:
                topic_scores["health"] += 15
            
            # Если это чистый медицинский/косметологический контекст - убираем моду
            medical_context = any(word in full_text for word in ["врач", "клиническ", "медицин", 
                                                                "терапия", "лечен", "процедур"])
            if medical_context and "fashion" in topic_scores and main_category != "fashion":
                topic_scores["fashion"] = max(0, topic_scores["fashion"] - 10)
        
        # 10. Путешествия и туризм → Развлечения, а не Быт
        travel_keywords = ["путешеств", "туризм", "каникулы", "отдых", "курорт", 
                          "тур", "поездк", "эгейском побережье", "турецкие каникулы",
                          "отпуск", "отдыха", "побережье", "путешествен"]
        if any(keyword in full_text for keyword in travel_keywords):
            if "entertainment" in topic_scores:
                topic_scores["entertainment"] += 10
            
            # Уменьшаем быт для туризма
            if "home" in topic_scores and main_category != "home":
                topic_scores["home"] = max(0, topic_scores["home"] - 8)
        
        # 11. Праздники и поздравления → Отношения, а не Развлечения (если семейный контекст)
        holiday_keywords = ["день отца", "открытк", "картинк", "поздравлени", "праздник",
                           "семейн", "семья", "папа", "отец", "родител"]
        if any(keyword in full_text for keyword in holiday_keywords):
            if "relationships" in topic_scores:
                topic_scores["relationships"] += 12
            
            # Для семейных праздников уменьшаем развлечения
            family_context = any(word in full_text for word in ["семья", "семейн", "родител", "отец", "папа"])
            if family_context and "entertainment" in topic_scores and main_category != "entertainment":
                topic_scores["entertainment"] = max(0, topic_scores["entertainment"] - 5)
        
        # 12. Образовательные программы и поддержка → Отношения/Здоровье, а не Развлечения
        education_keywords = ["программа", "обучение", "поддержк", "проект", "развитие",
                             "предприниматель", "образование", "курс", "тренинг"]
        if any(keyword in full_text for keyword in education_keywords):
            # Проверяем контекст: женский/семейный
            women_context = any(word in full_text for word in ["мама", "женщин", "женское", "материнств"])
            if women_context:
                if "relationships" in topic_scores:
                    topic_scores["relationships"] += 10
                
                # Уменьшаем развлечения для образовательных программ
                if "entertainment" in topic_scores and main_category != "entertainment":
                    topic_scores["entertainment"] = max(0, topic_scores["entertainment"] - 10)
        
        # 13. Детские мероприятия и гиды → Развлечения, а не Здоровье
        children_keywords = ["детей", "подростков", "детск", "ребенок", "гид по",
                            "мероприятия для детей", "квест", "интерактивн"]
        if any(keyword in full_text for keyword in children_keywords):
            if "entertainment" in topic_scores:
                topic_scores["entertainment"] += 8
            
            # Уменьшаем здоровье для детских развлечений
            if "health" in topic_scores and main_category != "health":
                topic_scores["health"] = max(0, topic_scores["health"] - 5)
        
        # 14. Модные статьи (одежда, аксессуары, стиль) → Мода, а не Здоровье
        if main_category == "fashion":
            # Проверяем модные ключевые слова (одежда, аксессуары, стиль)
            fashion_article_keywords = ["одежд", "наряд", "платье", "костюм", "юбк", "брюк",
                                       "пиджак", "куртк", "пальто", "сумк", "туфл", "обув",
                                       "аксессуар", "украшен", "кольц", "серьг", "браслет",
                                       "тартан", "клетк", "принт", "модн", "тренд", "стильн",
                                       "образ", "лук", "гардероб", "коллекц", "дизайнер", "бренд",
                                       "обручальн", "геммолог", "ювелирн", "истори", "эволюц"]
            has_fashion_article = any(keyword in full_text for keyword in fashion_article_keywords)
            
            # Если это модная статья (одежда, аксессуары), а не косметология - убираем здоровье
            if has_fashion_article:
                if "health" in topic_scores:
                    topic_scores["health"] = max(0, topic_scores["health"] - 15)  # Сильно уменьшаем здоровье
                
                # Усиливаем моду для модных статей
                if "fashion" in topic_scores:
                    topic_scores["fashion"] += 10
        
        # 15. Лечебные травы и растения → Здоровье, а не Отношения
        medicinal_keywords = [
            "мокриц", "звездчатк", "лечебн", "лечебные свойства", "применен", 
            "народн", "народная медицина", "медицин", "трава", "растен",
            "целебн", "целительн", "активные вещества", "регенерац", "стимулируют",
            "цинк", "железо", "магний", "каротин", "флавоноид", "дубильн",
            "лечен", "болезн", "симптом", "применяется при"
        ]
        if any(keyword in full_text for keyword in medicinal_keywords):
            if "health" in topic_scores:
                topic_scores["health"] += 15
            
            # Убираем отношения для лечебных трав
            if "relationships" in topic_scores and main_category != "relationships":
                topic_scores["relationships"] = max(0, topic_scores["relationships"] - 10)
            
            # Убираем быт для лечебных трав
            if "home" in topic_scores and main_category != "home":
                topic_scores["home"] = max(0, topic_scores["home"] - 10)
        
        # 16. Резюме и карьера → Отношения, а не Эзотерика
        career_keywords = [
            "резюме", "собеседование", "работодатель", "работа", "карьер",
            "соискатель", "ваканс", "трудоустройств", "професси", "должност",
            "найм", "нанять", "пригласили", "пригласить", "поиск работы",
            "первая работа", "фрилансер", "продвижение услуг", "продающий текст"
        ]
        if any(keyword in full_text for keyword in career_keywords):
            if "relationships" in topic_scores:
                topic_scores["relationships"] += 12
            
            # Сильно убираем эзотерику для резюме
            if "esoterics" in topic_scores and main_category != "esoterics":
                topic_scores["esoterics"] = max(0, topic_scores["esoterics"] - 20)
        
        # Сортируем темы по убыванию балла
        sorted_topics = sorted(topic_scores.items(), key=lambda x: x[1], reverse=True)
        
        # Выбираем темы
        topics = []
        
        if sorted_topics:
            # Добавляем основную тему первой (она должна быть с максимальным баллом)
            topics.append(main_category)
            
            # Добавляем вторую тему, если она достаточно сильная и не является основной
            for topic, score in sorted_topics:
                if topic != main_category:
                    # Вторая тема должна быть не менее 30% от первой
                    if score >= topic_scores[main_category] * 0.3:
                        # Исключаем комбинации, которые не имеют смысла
                        bad_combinations = [
                            ("esoterics", "celebrities"),  # Эзотерика и звезды - несовместимы
                            ("celebrities", "esoterics"),  # Звезды и эзотерика - несовместимы
                            ("health", "fashion"),  # Косметология уже учтена
                            ("relationships", "health"),  # Логопедия уже учтена
                            ("entertainment", "relationships"),  # Театр уже учтен
                            ("esoterics", "relationships"),  # Эзотерика и отношения - разные
                            ("cinema", "relationships")  # Кино и отношения - разные (кроме семейных сюжетов)
                        ]
                        
                        # Для кино - не добавляем отношения как вторую тему
                        if main_category == "cinema" and topic == "relationships":
                            # Проверяем, есть ли сильные маркеры отношений
                            strong_relationships = ["семья", "брак", "дети", "родител", "супруг", "жена", "муж", 
                                                  "любов", "роман", "развод", "измен"]
                            if not any(word in full_text for word in strong_relationships):
                                continue  # Пропускаем отношения для кино
                        
                        # Для эзотерики - не добавляем отношения как вторую тему
                        if main_category == "esoterics" and topic == "relationships":
                            continue  # Пропускаем отношения для эзотерики
                        
                        # Для звезд - не добавляем эзотерику как вторую тему (если нет явных маркеров)
                        if main_category == "celebrities" and topic == "esoterics":
                            # Проверяем, есть ли явные маркеры эзотерики
                            esoterics_markers = ["китайский календарь", "огненная лошадь", "год лошади",
                                                "гороскоп", "астролог", "к чему снится", "сон", "снится"]
                            has_esoterics_markers = any(marker in full_text for marker in esoterics_markers)
                            if not has_esoterics_markers:
                                continue  # Пропускаем эзотерику для новостей о звездах
                        
                        # Для резюме/карьеры - не добавляем эзотерику как вторую тему
                        career_keywords = [
                            "резюме", "собеседование", "работодатель", "работа", "карьер",
                            "соискатель", "ваканс", "трудоустройств", "професси", "должност",
                            "найм", "нанять", "пригласили", "пригласить", "поиск работы",
                            "первая работа", "фрилансер", "продвижение услуг", "продающий текст"
                        ]
                        if any(keyword in full_text for keyword in career_keywords):
                            if topic == "esoterics":
                                continue  # Пропускаем эзотерику для резюме
                        
                        # Для лечебных трав - не добавляем отношения как вторую тему
                        medicinal_keywords = [
                            "мокриц", "звездчатк", "лечебн", "лечебные свойства", "применен", 
                            "народн", "народная медицина", "медицин", "трава", "растен",
                            "целебн", "целительн", "активные вещества", "регенерац", "стимулируют"
                        ]
                        if any(keyword in full_text for keyword in medicinal_keywords):
                            if topic == "relationships" and main_category != "relationships":
                                continue  # Пропускаем отношения для лечебных трав
                            if topic == "home" and main_category != "home":
                                continue  # Пропускаем быт для лечебных трав
                        
                        # Для моды - не добавляем здоровье как вторую тему (если это не косметология)
                        if main_category == "fashion" and topic == "health":
                            # Проверяем, есть ли модные ключевые слова (одежда, аксессуары, стиль)
                            fashion_article_keywords = ["одежд", "наряд", "платье", "костюм", "юбк", "брюк",
                                                       "пиджак", "куртк", "пальто", "сумк", "туфл", "обув",
                                                       "аксессуар", "украшен", "кольц", "серьг", "браслет",
                                                       "тартан", "клетк", "принт", "модн", "тренд", "стильн",
                                                       "образ", "лук", "гардероб", "коллекц", "дизайнер", "бренд",
                                                       "обручальн", "геммолог", "ювелирн"]
                            has_fashion_article = any(keyword in full_text for keyword in fashion_article_keywords)
                            
                            # Если это модная статья (одежда, аксессуары), а не косметология - пропускаем здоровье
                            if has_fashion_article:
                                continue  # Пропускаем здоровье для модных статей
                        
                        if (main_category, topic) not in bad_combinations:
                            topics.append(topic)
                            break
        
        # Ограничиваем 2 темами
        topics = topics[:2]
        
        # Для эзотерики - только одна тема
        if main_category == "esoterics" and len(topics) > 1:
            # Но если это сон о поцелуе, может быть и отношения как вторая тема
            if not ("к чему снится" in full_text or "сон" in full_text):
                topics = ["esoterics"]
        
        # Для кино - максимум 2 темы
        if main_category == "cinema" and len(topics) > 2:
            topics = topics[:2]
        
        # Убираем дубликаты
        unique_topics = []
        for topic in topics:
            if topic not in unique_topics:
                unique_topics.append(topic)
        
        return unique_topics
    
    def label_article(self, article: Dict) -> Dict:
        """
        Разметка одной статьи
        """
        try:
            # Извлекаем данные
            title = article.get('title', '')
            text = article.get('text', '')
            original_category = article.get('category', '')
            
            # Определяем основную категорию
            category = self.detect_category(original_category, text, title)
            
            # Определяем тональность с учетом категории
            sentiment = self.detect_sentiment(text, title, category)
            
            # Определяем множественные темы
            multilabel_topics = self.detect_multilabel_topics(text, title, original_category)
            
            # Обновляем статистику
            self.stats['total'] += 1
            self.stats[f'sentiment_{sentiment}'] += 1
            self.stats[f'category_{category}'] += 1
            
            # Переводим темы на русский для вывода
            category_russian = TOPIC_RUSSIAN_NAMES.get(category, category)
            multilabel_topics_russian = translate_topics_to_russian(multilabel_topics)
            
            # Убедимся, что основная тема есть в списке тем
            if category_russian not in multilabel_topics_russian:
                multilabel_topics_russian.insert(0, category_russian)
            
            # Убираем дубликаты
            unique_topics = []
            for topic in multilabel_topics_russian:
                if topic not in unique_topics:
                    unique_topics.append(topic)
            
            return {
                'sentiment': sentiment,
                'category': category_russian,
                'categories': unique_topics[:2]  # Максимум 2 темы
            }
            
        except Exception as e:
            # В случае ошибки возвращаем значения по умолчанию
            print(f"Ошибка при разметке: {e}")
            return {
                'sentiment': 'positive',
                'category': TOPIC_RUSSIAN_NAMES.get('entertainment', 'Развлечения'),
                'categories': [TOPIC_RUSSIAN_NAMES.get('entertainment', 'Развлечения')]
            }
    
    def label_articles(self, articles: List[Dict]) -> List[Dict]:
        """
        Разметка всех статей
        """
        labeled_articles = []
        
        print(f"Размечаю {len(articles)} статей...")
        
        for i, article in enumerate(articles):
            if i % 100 == 0:
                print(f"  Обработано: {i} статей")
            
            # Получаем разметку
            labels = self.label_article(article)
            
            # Создаем новую статью с разметкой
            labeled_article = {
                'title': article.get('title', ''),
                'text': article.get('text', ''),
                'original_category': article.get('category', ''),
                'sentiment': labels['sentiment'],
                'category': labels['category'],
                'categories': labels['categories']
            }
            
            # Добавляем дополнительные поля, если они есть
            for field in ['date', 'source', 'url', 'author']:
                if field in article:
                    labeled_article[field] = article[field]
            
            labeled_articles.append(labeled_article)
        
        print(f"Разметка завершена. Обработано: {len(labeled_articles)} статей")
        return labeled_articles

# ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========

def load_articles(file_path: str) -> List[Dict]:
    """
    Загрузка статей из JSONL файла
    """
    articles = []
    
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            for line in f:
                line = line.strip()
                if line:
                    try:
                        article = json.loads(line)
                        articles.append(article)
                    except json.JSONDecodeError:
                        continue
    except FileNotFoundError:
        print(f"Файл не найден: {file_path}")
    except Exception as e:
        print(f"Ошибка при загрузке: {e}")
    
    print(f"Загружено {len(articles)} статей")
    return articles

def save_articles(articles: List[Dict], file_path: str):
    """
    Сохранение статей в JSONL файл
    """
    try:
        with open(file_path, 'w', encoding='utf-8') as f:
            for article in articles:
                f.write(json.dumps(article, ensure_ascii=False) + '\n')
        print(f"Сохранено {len(articles)} статей в {file_path}")
        return True
    except Exception as e:
        print(f"Ошибка при сохранении: {e}")
        return False

def split_dataset(articles: List[Dict], train_ratio=0.7, val_ratio=0.15, test_ratio=0.15):
    """
    Разделение набора данных на train/val/test
    """
    random.shuffle(articles)
    
    n = len(articles)
    train_end = int(n * train_ratio)
    val_end = train_end + int(n * val_ratio)
    
    train = articles[:train_end]
    val = articles[train_end:val_end]
    test = articles[val_end:]
    
    print(f"\nРазделение данных:")
    print(f"  Train: {len(train)} статей ({len(train)/n*100:.1f}%)")
    print(f"  Val: {len(val)} статей ({len(val)/n*100:.1f}%)")
    print(f"  Test: {len(test)} статей ({len(test)/n*100:.1f}%)")
    
    return train, val, test

def print_statistics(articles: List[Dict]):
    """
    Печать статистики размеченных данных
    """
    if not articles:
        print("Нет данных для статистики")
        return
    
    sentiments = Counter()
    categories = Counter()
    topic_counts = Counter()
    topics_per_article = []
    
    for article in articles:
        sentiments[article.get('sentiment', 'unknown')] += 1
        categories[article.get('category', 'unknown')] += 1
        
        topics = article.get('categories', [])
        topics_per_article.append(len(topics))
        for topic in topics:
            topic_counts[topic] += 1
    
    print("\n" + "="*50)
    print("СТАТИСТИКА РАЗМЕТКИ")
    print("="*50)
    
    print(f"\nВсего статей: {len(articles)}")
    
    print("\nРаспределение тональности:")
    for sentiment, count in sorted(sentiments.items()):
        percentage = count / len(articles) * 100
        print(f"  {sentiment}: {count} ({percentage:.1f}%)")
    
    print("\nРаспределение категорий:")
    for category, count in sorted(categories.items()):
        percentage = count / len(articles) * 100
        print(f"  {category}: {count} ({percentage:.1f}%)")
    
    print("\nРаспределение тем (многометочная):")
    for topic, count in topic_counts.most_common(10):
        percentage = count / len(articles) * 100
        print(f"  {topic}: {count} ({percentage:.1f}%)")
    
    avg_topics = sum(topics_per_article) / len(topics_per_article) if topics_per_article else 0
    print(f"\nСреднее количество тем на статью: {avg_topics:.2f}")
    print("="*50)

# ========== ТЕСТИРОВАНИЕ НА ПРИМЕРАХ ==========

def test_examples():
    """
    Тестирование на примерах из сообщения
    """
    test_articles = [
        {
            "title": "Пример 7: Стало известно о тайном переезде Меган Маркл и принца Гарри...",
            "text": "Меган Маркл и принц Гарри после своего переезда в Америку полным ходом осваивают искусство конспирации и уже добились в этом деле впечатляющих успехов. Им удалось с блеском провести калифорнийских папарацци: как оказалось, они уже больше месяца назад перебрались на новое место жительства. И это не слухи, факт переезда подтвердил их официальный представитель. Как сообщается, теперь пара живет не в Беверли Хиллз, а за пределами Лос-Анджелеса — в Санта Барбаре. Причем на этот раз Меган и Гарри не п...",
            "category": "Новости"
        },
        {
            "title": "Пример 9: К чему снится поцелуй...",
            "text": "Поцелуй — очень многогранный и глубокий символ, который не следует истолковывать плоско и однозначно. Толковать поцелуй сонник будет с учетом множества подробностей увиденной сцены. Давайте разберемся, на что именно нужно обратить внимание, чтобы понять значение и тайный смысл такого видения. Видеть во сне целующуюся пару — к прибыли, к удачной сделке или хорошему предложению о сотрудничестве. Если пара молодая или одета в свадебные одеяния, сделка состоится в ближайший месяц, если же пара пожил...",
            "category": "Гороскопы"
        }
    ]
    
    print("Тестирование на примерах из задания:")
    print("="*70)
    
    labeler = AutoLabeler()
    
    for i, article in enumerate(test_articles):
        print(f"\n{article['title']}")
        print(f"Исходная категория: {article['category']}")
        
        labels = labeler.label_article(article)
        
        print(f"Тональность: {labels['sentiment']}")
        print(f"Тема: {labels['category']}")
        print(f"Темы (множественные): {', '.join(labels['categories'])}")
        print("-" * 70)

# ========== ОСНОВНАЯ ФУНКЦИЯ ==========

def main():
    """
    Основная функция для запуска разметки
    """
    # Настройки
    INPUT_FILE = "corpus_lab1.jsonl"  # Ваш исходный корпус
    OUTPUT_DIR = "labeled_corpus"    # Директория для результатов
    
    # 1. Загружаем статьи
    print("Загрузка статей...")
    articles = load_articles(INPUT_FILE)
    
    if not articles:
        print("Не удалось загрузить статьи!")
        return
    
    # 2. Создаем лейблер и размечаем статьи
    print("\nАвтоматическая разметка...")
    labeler = AutoLabeler()
    labeled_articles = labeler.label_articles(articles)
    
    # 3. Показываем статистику
    print_statistics(labeled_articles)
    
    # 4. Разделяем на train/val/test
    print("\nРазделение на train/val/test...")
    train_set, val_set, test_set = split_dataset(labeled_articles)
    
    # 5. Сохраняем результаты
    import os
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    
    print("\nСохранение результатов...")
    save_articles(labeled_articles, os.path.join(OUTPUT_DIR, "full_corpus.jsonl"))
    save_articles(train_set, os.path.join(OUTPUT_DIR, "train.jsonl"))
    save_articles(val_set, os.path.join(OUTPUT_DIR, "val.jsonl"))
    save_articles(test_set, os.path.join(OUTPUT_DIR, "test.jsonl"))
    
    # 6. Примеры разметки
    print("\nПримеры разметки (первые 5 статей):")
    print("-" * 70)
    for i, article in enumerate(labeled_articles[:5]):
        print(f"\nПример {i+1}:")
        print(f"  Заголовок: {article.get('title', '')[:60]}...")
        print(f"  Тональность: {article.get('sentiment', 'unknown')}")
        print(f"  Категория: {article.get('category', 'unknown')}")
        print(f"  Темы: {article.get('categories', [])}")
    
    print("\n" + "="*70)
    print("РАЗМЕТКА ЗАВЕРШЕНА УСПЕШНО!")
    print("="*70)

# ========== ЗАПУСК ==========

if __name__ == "__main__":
    # Тестирование на примере
    print("Запуск теста на примерах из задания...")
    print("="*70)
    test_examples()
    
    # Запуск основной разметки
    print("\n\n" + "="*70)
    print("ЗАПУСК ОСНОВНОЙ РАЗМЕТКИ")
    print("="*70)
    main()